name: Daily RSS Digest

on:
  schedule:
    # Runs at 10:00 Beijing Time (02:00 UTC)
    - cron: '0 2 * * *'
  workflow_dispatch: # Allows manual run

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.NEXT_PUBLIC_SANITY_PROJECT_ID }}
      NEXT_PUBLIC_SANITY_DATASET: ${{ secrets.NEXT_PUBLIC_SANITY_DATASET }}
      SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
      AI_API_KEY: ${{ secrets.AI_API_KEY }}
      AI_BASE_URL: ${{ secrets.AI_BASE_URL }}
      IMAGE_GEN_API_KEY: ${{ secrets.IMAGE_GEN_API_KEY }}
      IMAGE_GEN_API_URL: ${{ secrets.IMAGE_GEN_API_URL }}
      IMAGE_GEN_MODEL: ${{ secrets.IMAGE_GEN_MODEL }}
      WECHAT_APP_ID: ${{ secrets.WECHAT_APP_ID }}
      WECHAT_APP_SECRET: ${{ secrets.WECHAT_APP_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Run RSS Fetch Script
        run: npx tsx scripts/fetch-rss.ts

      - name: Run Translation Sync (Backfill & Update)
        run: npx tsx scripts/sync-translations.ts

      - name: Run WeChat Sync (Official Account)
        run: npx tsx scripts/sync-wechat.ts
